---
layout: post
title: linux系统编程之高级IO
excerpt: "linux系统编程"
categories: [linux系统编程]
comments: true
---
关于io: 只要涉及到文件的IO操作，就必然有文件描述符这个东西，所以本章所有的IO高级操作，都是使用fd来实现的。

关于阻塞IO的demo
```
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <errno.h>
#include <string.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>


void print_err(char *str, int line, int err_no)
{
        printf("%d, %s: %s\n", line, str, strerror(err_no));
        exit(-1);
}


int main(void)
{	
	int cor; //存放鼠标光标的坐标
	int mousefd = -1;
	int ret = 0;
	char buf[100] = {0};

	//mousefd = open("/dev/input/mouse0", O_RDONLY|O_NONBLOCK);
	//if(mousefd == -1) print_err("open mouse0 fail", __LINE__, errno);

	
	//重设0
	//fcntl(0, F_SETFL, O_RDONLY|O_NONBLOCK);
	
	//补设
	int flag = fcntl(0, F_GETFL);
	flag = flag | O_NONBLOCK;
	fcntl(0, F_SETFL, flag); 
	

	while(1)
	{
		//printf("111\n");
		//ret = read(mousefd, &cor, sizeof(cor));	
		//if(ret > 0) printf("%u\n", cor);
		//else if(ret==-1 && errno!=EAGAIN) print_err("read mouse0 fail", __LINE__, errno);
			
		//ret = read(0, buf, sizeof(buf));	
		ret = scanf("%s", buf);
		if(ret > 0) printf("%s\n", buf);
		//printf("222\n");
	}
	
	return 0;
}
```
监控鼠标操作,阻塞demo
```
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <errno.h>
#include <string.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>


void print_err(char *str, int line, int err_no)
{
        printf("%d, %s: %s\n", line, str, strerror(err_no));
        exit(-1);
}


int main(void)
{	
	int cor; //存放鼠标光标的坐标
	int mousefd = -1;
	int ret = 0;
	char buf[100] = {0};

	mousefd = open("/dev/input/mouse0", O_RDONLY);
	//mousefd = open("/dev/input/mouse0", O_RDONLY|O_NONBLOCK);
	if(mousefd == -1) print_err("open mouse0 fail", __LINE__, errno);

	
	//重设0
	//fcntl(0, F_SETFL, O_RDONLY|O_NONBLOCK);
	
	//补设
//	int flag = fcntl(0, F_GETFL);
	//flag = flag | O_NONBLOCK;
	//fcntl(0, F_SETFL, flag); 
	

	while(1)
	{
		printf("111\n");
		ret = read(mousefd, &cor, sizeof(cor));	
		if(ret > 0) printf("%u\n", cor);
		else if(ret==-1 && errno!=EAGAIN) print_err("read mouse0 fail", __LINE__, errno);
			
		//ret = read(0, buf, sizeof(buf));	
		//ret = scanf("%s", buf);
		//if(ret > 0) printf("%s\n", buf);
		//printf("222\n");
	}
	return 0;
}
```
#### 非阻塞
实现非阻塞的两种方式

1. 打开文件时指定O_NONBLOCK状态标志
2. 通过fcntl函数指定O_NONBLOCK来实现

例如
```
mousefd = open("/dev/input/mouse0", O_RDONLY|O_NONBLOCK);
```
或者通过fcntl重设
```
mousefd = open("/dev/input/mouse0", O_RDONLY);
fcntl(0, F_SETFL, O_RDONLY|O_NONBLOCK);
```
或者通过fcntl补设
```

```